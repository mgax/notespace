<html>
<head>
    <link type="text/css" href="/static/jq/themes/smoothness/ui.all.css" rel="stylesheet" />
    <style>
        body { background-color: #aaa; font-family: Georgia; margin: 0; }
        div#notes {}
        div.note {
            position: absolute; width: 200px; height: 150px; padding: .2em;
            background-color: #669; border: 1px solid #446;
            overflow: hidden;
        }
    </style>
    <script type="text/javascript" src="/static/jq/jquery-1.3.2.js"></script>
    <script type="text/javascript" src="/static/jq/ui/ui.core.js"></script>
    <script type="text/javascript" src="/static/jq/ui/ui.draggable.js"></script>
    <script type="text/javascript" src="/static/jq/ui/ui.resizable.js"></script>
    <script type="text/javascript">
        $.make_note = function(note_id, note_props, parent_note) {
            var note = $('<div>').append( $('<p>').append(note_props['desc']) );
            note.append( $('<a>').append('[+]').click(on_add_child) );

            var note_children;
            $.getJSON('/notes/' + note_id + '/children', function(data) {
                note_children = data;
                var children_div = $('<div class="children">')[0];
                note.append(children_div);
                $.each(data, function(item) {
                    var child_note_id = this
                    $.getJSON('/notes/' + child_note_id, function(data) {
                        $.make_note(child_note_id, data, children_div);
                    });
                });
            });

            note.attr('id', note_id).attr('class', 'note');
            note.css({'background-color': '#669', 'border-color': '#446',
                    'left': note_props['x'], 'top': note_props['y'],
                    'width': note_props['w'], 'height': note_props['h']});
            note.resizable({stop: after_resize}).draggable({stop: after_drag});
            $('p:first', note).click(edit_begin);

            $(parent_note).append(note);

            function on_add_child() {
                var child_note_props = {desc: 'kid'};
                $.post('/notes', child_note_props, function(data) {
                    var child_note_id = data;
                    note_children.push(child_note_id);
                    console.log('on_add_child made kid with note_id=' + child_note_id);
                    $.post('/notes/' + note_id + '/children',
                      {children: '['+note_children+']'}, function(data) {
                        $.make_note(child_note_id, child_note_props,
                            $('div.children', note)[0]);
                    }, 'json');
                }, 'json');
            }
            function edit_begin() {
                var view = $('p:first', note);
                var input = $('<textarea>').append(view.contents());
                view.replaceWith(input);
                var done_button = $('<a>').append('done').click(function() {
                    done_button.remove();
                    edit_done();
                });
                input.after(done_button);
            }
            function edit_done() {
                var input = $('textarea', note);
                var value = input.val();
                input.val('saving');
                note_props['desc'] = value;
                $.post('/notes/' + note_id, note_props, function(data) {
                    var view = $('<p>').append(value);
                    view.click(edit_begin);
                    input.replaceWith(view);
                }, 'json');
            }
            function after_resize() {
                note_props['w'] = note.css('width');
                note_props['h'] = note.css('height');
                $.post('/notes/' + note_id, note_props);
            }
            function after_drag() {
                note_props['x'] = note.css('left');
                note_props['y'] = note.css('top');
                $.post('/notes/' + note_id, note_props);
            }
        }

        $(function() {
            $.getJSON('/notes/0', function(data) {
                $.make_note(0, data, $('body')[0]);
            });
        });
    </script>
</head>
<body>

</body>
</html>
